# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **DevContainer environment** specifically designed for Claude Code integration with full Python, Jupyter, Docker, and Playwright support. The repository provides a production-ready, security-hardened development container for AI-assisted development, data science, browser automation, and containerized application testing.

**Key Architecture Decision**: This project uses Docker-outside-of-Docker (DooD) instead of Docker-in-Docker, mounting the host Docker socket for better performance and security without requiring privileged containers.

## Essential Commands

### Python Development

```bash
# Activate the virtual environment (REQUIRED for Python work)
source ~/.venv/bin/activate

# Run Python scripts
python main.py

# Install new Python packages
uv pip install package-name

# Install project in editable mode
uv pip install -e .

# Code formatting
black filename.py

# Code linting
pylint filename.py
```

### Jupyter Notebooks

```bash
# Activate venv first
source ~/.venv/bin/activate

# Start JupyterLab (opens in browser)
jupyter lab

# Start classic Jupyter Notebook
jupyter notebook

# Run IPython interactive shell
ipython
```

**Important**: In VS Code, when opening `.ipynb` files, select the Python kernel from `~/.venv/bin/python` (not the system Python).

### Docker Operations

```bash
# Build Docker images
docker build -t image-name .

# Run containers
docker run -d -p 8080:8080 image-name

# View running containers
docker ps

# View logs
docker logs container-id

# Clean up
docker system prune -f
```

**Note**: Docker commands control the HOST Docker daemon (Docker-outside-of-Docker setup). Containers you create are siblings to the devcontainer, not children.

### Playwright Browser Automation

```bash
# Navigate to the Playwright tools directory
cd ~/web-ui-optimizer

# Run Python Playwright optimizer
python ui_optimizer.py https://example.com

# Verify Playwright setup
./verify_setup.sh

# Reinstall browsers if needed
python -m playwright install chromium
```

**Environment Variables**:
- `DISPLAY=:99` - Xvfb virtual display for headless browser automation
- `PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright` - Browser cache location

### Testing

```bash
# Run pytest tests
pytest

# Run tests with Playwright
pytest --headed  # Show browser
pytest --browser chromium  # Specific browser
```

### Package Management

```bash
# uv (fast Python package manager) is the primary tool
uv pip install package-name
uv pip list
uv pip freeze

# Update pyproject.toml dependencies, then:
uv pip install -e .
```

## Architecture & Structure

### DevContainer Configuration

**Location**: `.devcontainer/`

- **`devcontainer.json`** (570 lines): Comprehensive DevContainer configuration with extensive inline documentation
  - Base image: `mcr.microsoft.com/devcontainers/python:3.12-bookworm`
  - Features: Node.js 22, GitHub CLI, Docker-outside-of-Docker
  - VS Code extensions: Claude Code, Python, Jupyter, Playwright, Docker, GitLens, etc.
  - Security: Non-root `vscode` user, no `SYS_ADMIN` capability, no `ipc=host`
  - Resource requirements: 2 CPUs, 4GB RAM, 32GB disk

- **`post-create.sh`** (1251 lines): Setup script that runs once after container creation
  - Installs system dependencies for Chromium/Playwright
  - Creates Python virtual environment at `~/.venv`
  - Installs pinned Python packages (security: prevents supply chain attacks)
  - Sets up Xvfb virtual display (`:99`) for headless browser automation
  - Creates `~/web-ui-optimizer` project with Playwright tools
  - Installs Playwright browsers (Chromium)

### Virtual Environment

**Critical**: This project uses a Python virtual environment at `~/.venv` (NOT `.venv` in project root).

- Location: `/home/vscode/.venv/`
- Activation: `source ~/.venv/bin/activate`
- The virtual environment is automatically activated in new bash sessions via `.bashrc`
- All Python packages (Jupyter, Playwright, pytest, etc.) are installed in this venv

### Docker Integration (DooD)

**Docker-outside-of-Docker Setup**:
1. Docker CLI installed in container
2. Host Docker socket mounted at `/var/run/docker.sock`
3. Containers created are siblings to devcontainer, not children
4. No `--privileged` flag required (safer than Docker-in-Docker)

**Security Implications**:
- Access to Docker socket = root-equivalent access to host
- Acceptable for development, not for production
- Better alternative than privileged containers or mounting host directories

### Playwright & Browser Automation

**Architecture**:
- Chromium browser installed via Playwright
- Xvfb virtual display (`:99`) for headless rendering
- Shared memory size: 2GB (`--shm-size=2gb` in runArgs)
- Browsers cached in volume: `~/.cache/ms-playwright`

**Security Note**: Browsers run with `--no-sandbox` flag (acceptable in dev containers, required because we don't use `SYS_ADMIN` capability).

### Web UI Optimizer Project

**Location**: `~/web-ui-optimizer/`

A pre-configured Playwright project created during setup with tools for:
- Responsive screenshot capture (mobile, tablet, desktop)
- Color palette analysis
- Accessibility checking
- Performance metrics
- Before/after visual comparisons

**Files**:
- `ui_optimizer.py` - Python-based Playwright tools
- `verify_setup.sh` - Installation verification script
- `README.md` - Usage documentation

## Development Workflow

### Starting New Python Projects

1. Activate virtual environment: `source ~/.venv/bin/activate`
2. Create project structure: `mkdir -p src tests notebooks data`
3. Update `pyproject.toml` with project metadata and dependencies
4. Install project: `uv pip install -e .`
5. Add source files to `src/`
6. Add tests to `tests/`
7. Create notebooks in `notebooks/`

### Working with Jupyter Notebooks

- Always activate venv first: `source ~/.venv/bin/activate`
- In VS Code: Select kernel from `~/.venv/bin/python`
- JupyterLab provides full IDE experience
- Jupyter Notebook provides classic interface
- IPython for interactive Python shell

### Docker Workflow

1. Write Dockerfile
2. Build: `docker build -t app:latest .`
3. Test: `docker run -d -p 8080:8080 app:latest`
4. Verify: `curl http://localhost:8080`
5. Clean up: `docker stop $(docker ps -q) && docker system prune -f`

### Playwright Automation

1. Navigate to tools: `cd ~/web-ui-optimizer`
2. Run optimizer: `python ui_optimizer.py https://example.com`
3. Check results in generated output files
4. Modify scripts as needed for your use case

## Security Considerations

### Hardened Configuration

This DevContainer has been security-hardened:

**Removed dangerous capabilities**:
- ❌ `SYS_ADMIN` - Near-root privileges, container escape risk
- ❌ `ipc=host` - Breaks container isolation
- ✅ Replaced with `--shm-size=2gb` for browser rendering

**Supply chain protection**:
- All package versions pinned (Python, npm)
- No `^` or `~` version ranges
- Intentional updates only
- Protected against typosquatting and compromised packages

**Additional measures**:
- Non-root `vscode` user (with sudo access)
- Minimal package installation
- No secrets in configuration files
- Xvfb without network listeners

### Docker Socket Access

The Docker socket mount (`/var/run/docker.sock`) provides root-equivalent access. This is acceptable for development because:
- Better than `--privileged` flag
- Standard practice for DevContainers
- Host Docker daemon enforces security policies
- More secure than mounting arbitrary host paths

**Never use in production or untrusted environments.**

## Important Notes for Claude Code

### File Paths
- Project root: `/workspaces/claude_in_devcontainer/`
- Virtual environment: `/home/vscode/.venv/` (not `/workspaces/claude_in_devcontainer/.venv/`)
- Web UI optimizer: `/home/vscode/web-ui-optimizer/`
- Playwright cache: `/home/vscode/.cache/ms-playwright/`

### Common Pitfalls

1. **Forgetting to activate venv**: Always run `source ~/.venv/bin/activate` before Python/Jupyter commands
2. **Wrong Python path**: Use `/home/vscode/.venv/bin/python`, not `/usr/local/bin/python`
3. **Docker not available**: If Docker commands fail, check if the container was started with Docker feature enabled
4. **Playwright browser not found**: Run `python -m playwright install chromium` to reinstall
5. **Display errors**: Ensure `DISPLAY=:99` is set and Xvfb is running

### Port Forwarding

These ports are automatically forwarded by VS Code:
- 3000-3001: React, Next.js, Node.js
- 4000: GraphQL servers
- 5000: Flask, Python web apps
- 5173-5174: Vite dev servers
- 8000: FastAPI, Django
- 8080-8081: Alternative HTTP, proxies
- 9000: PHP, management UIs

### VS Code Integration

- Claude Code extension pre-installed
- Python extension with Pylance for IntelliSense
- Jupyter extension for notebook support
- Docker extension for container management
- Playwright extension for test debugging
- GitLens for Git visualization

### Resource Requirements

**Minimum**: 2 CPUs, 4GB RAM, 32GB disk
**Recommended**: 4-8 CPUs, 8-16GB RAM, 50GB+ disk for ML/AI workloads

On macOS/Windows, increase Docker Desktop resources in Settings → Resources.

## Package Versions

All packages are pinned for security. Update intentionally:

**Python packages** (in `post-create.sh`):
- playwright==1.55.0
- pytest==7.4.3
- black==23.12.1
- pylint==3.0.3
- numpy==1.26.2
- pandas==2.3.3
- ipython==8.18.1

**Project dependencies** (in `pyproject.toml`):
- jupyter>=1.1.1

## Troubleshooting

### Container won't start
- Check Docker Desktop is running
- Verify disk space: `df -h`
- Check logs: VS Code → Output → Dev Containers
- Try rebuilding: Cmd+Shift+P → "Rebuild Container"

### Jupyter not found
- Activate venv: `source ~/.venv/bin/activate`
- Verify installation: `jupyter --version`
- Reinstall if needed: `uv pip install jupyter jupyterlab`

### Docker commands fail
- Verify Docker socket: `ls -l /var/run/docker.sock`
- Check Docker access: `docker ps`
- Ensure Docker-outside-of-Docker feature is enabled in `devcontainer.json`

### Playwright issues
- Reinstall browsers: `python -m playwright install chromium --with-deps`
- Check display: `echo $DISPLAY` (should be `:99`)
- Verify Xvfb: `ps aux | grep Xvfb`

### Out of disk space
- Clean Docker: `docker system prune -a --volumes`
- Check usage: `du -sh ~/.cache/ms-playwright`
- Remove unused containers: `docker container prune`
